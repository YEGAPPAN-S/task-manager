<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cartrabbit Task Board</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 36 36'><rect width='36' height='36' rx='10' fill='%236C63FF'/><text x='8' y='26' font-size='20' fill='white'>T</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0B0E14;--bg-card:#131720;--bg-col:#0F1219;--bg-hover:#1A1F2E;--bg-input:#161B26;
  --border:#1E2433;--border-h:#2A3148;--text:#E2E8F0;--text-dim:#8892A8;--text-muted:#5A6478;
  --accent:#6C63FF;--accent-g:rgba(108,99,255,.15);--danger:#EF4444;--success:#22C55E;--warn:#F59E0B;
  --flycart:#1f87ff;--yuko:#6c62f4;--retainful:#f75a1b;--wployalty:#5149eb;
  --upsellwp:#043785;--spark:#165236;--other:#64748B;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:auto}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
button{font-family:'DM Sans',sans-serif;cursor:pointer}
input,select,textarea{font-family:'DM Sans',sans-serif}

/* â”€â”€â”€ Login â”€â”€â”€ */
#login{display:flex;align-items:center;justify-content:center;min-height:100vh;position:relative;overflow:hidden}
#login::before{content:'';position:absolute;width:600px;height:600px;background:radial-gradient(circle,rgba(108,99,255,.08) 0%,transparent 70%);top:-200px;right:-200px;pointer-events:none}
#login::after{content:'';position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(249,115,22,.06) 0%,transparent 70%);bottom:-200px;left:-100px;pointer-events:none}
.login-box{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:44px 38px;width:400px;max-width:92vw;position:relative;z-index:1}
.logo{display:flex;align-items:center;gap:12px;margin-bottom:6px}
.logo h1{font-size:21px;font-weight:700;letter-spacing:-.5px}
.logo span{color:var(--accent)}
.subtitle{color:var(--text-dim);font-size:13px;margin-bottom:28px}
.fg{margin-bottom:16px}
.fg label{display:block;font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.fg select,.fg input,.fg textarea{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s}
.fg select:focus,.fg input:focus,.fg textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-g)}
.fg select option{background:var(--bg-card);color:var(--text)}
.fg .hint{font-size:10px;color:var(--text-muted);margin-top:4px}
.fg textarea{resize:vertical;min-height:68px}
.btn-login{width:100%;padding:12px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;transition:all .2s;margin-top:4px}
.btn-login:hover{background:#5B54E6;transform:translateY(-1px);box-shadow:0 4px 20px var(--accent-g)}
.btn-login:disabled{opacity:.5;cursor:not-allowed;transform:none}
.msg{font-size:12px;margin-top:10px;text-align:center;display:none}
.msg.err{color:var(--danger);display:block}
.msg.ok{color:var(--success);display:block}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ App â”€â”€â”€ */
#app{display:none;min-height:100vh;flex-direction:column}

.header{display:flex;align-items:center;justify-content:space-between;padding:12px 22px;border-bottom:1px solid var(--border);background:var(--bg-card);position:sticky;top:0;z-index:100;gap:10px;flex-wrap:wrap}
.h-left{display:flex;align-items:center;gap:12px}
.h-logo{display:flex;align-items:center;gap:8px;font-size:17px;font-weight:700;white-space:nowrap}
.h-logo span{color:var(--accent)}
.h-center{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.h-right{display:flex;align-items:center;gap:8px}

.fbtn{padding:4px 11px;background:transparent;border:1px solid var(--border);border-radius:7px;color:var(--text-dim);font-size:11px;font-weight:500;transition:all .15s;white-space:nowrap}
.fbtn:hover{border-color:var(--border-h);color:var(--text)}
.fbtn.on{background:var(--accent-g);border-color:var(--accent);color:var(--accent)}
.fbtn[data-p="Flycart"].on{border-color:var(--flycart);color:var(--flycart);background:rgba(31,135,255,.1)}
.fbtn[data-p="Yuko"].on{border-color:var(--yuko);color:var(--yuko);background:rgba(108,98,244,.1)}
.fbtn[data-p="Retainful"].on{border-color:var(--retainful);color:var(--retainful);background:rgba(247,90,27,.1)}
.fbtn[data-p="WPLoyalty"].on{border-color:var(--wployalty);color:var(--wployalty);background:rgba(81,73,235,.1)}
.fbtn[data-p="UpsellWP"].on{border-color:#4d8ee0;color:#4d8ee0;background:rgba(4,55,133,.15)}
.fbtn[data-p="Spark Editor"].on{border-color:#3dbb7a;color:#3dbb7a;background:rgba(22,82,54,.15)}
.fbtn[data-p="Other Works"].on{border-color:var(--other);color:var(--other);background:rgba(100,116,139,.1)}

.sep{width:1px;height:18px;background:var(--border);margin:0 3px}
.badge{display:flex;align-items:center;gap:7px;padding:4px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;font-size:12px;font-weight:500}
.avatar{border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
.avatar-sm{width:22px;height:22px;font-size:9px}
.avatar-xs{width:18px;height:18px;font-size:8px}
.ibtn{width:32px;height:32px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-dim);transition:all .15s}
.ibtn:hover{border-color:var(--border-h);color:var(--text);background:var(--bg-hover)}
.sync{font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;white-space:nowrap}
.sync.ok{color:var(--success)}.sync.err{color:var(--danger)}.sync.load{color:var(--warn)}

.sbox{display:flex;align-items:center;gap:7px;padding:4px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:8px;transition:border-color .2s}
.sbox:focus-within{border-color:var(--accent)}
.sbox input{background:none;border:none;color:var(--text);font-size:12px;outline:none;width:130px}
.sbox svg{color:var(--text-muted);flex-shrink:0}

/* â”€â”€â”€ Board â”€â”€â”€ */
.board{display:flex;gap:16px;padding:18px 22px;flex:1;overflow-x:auto;align-items:flex-start}
.col{min-width:300px;max-width:300px;flex-shrink:0;background:var(--bg-col);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;max-height:calc(100vh - 105px)}
.col-head{display:flex;align-items:center;justify-content:space-between;padding:13px 14px 9px;border-bottom:1px solid var(--border)}
.col-title{display:flex;align-items:center;gap:9px;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px}
.col-dot{width:7px;height:7px;border-radius:50%}
.col[data-s="not-started"] .col-dot{background:#64748B}
.col[data-s="pending"] .col-dot{background:#F59E0B}
.col[data-s="working"] .col-dot{background:#3B82F6}
.col[data-s="completed"] .col-dot{background:#22C55E}
.col-cnt{background:var(--bg-hover);padding:1px 9px;border-radius:12px;font-size:11px;font-weight:600;color:var(--text-dim)}
.col-add{display:flex;align-items:center;justify-content:center;width:24px;height:24px;background:transparent;border:1px dashed var(--border);border-radius:5px;color:var(--text-muted);font-size:15px;transition:all .15s}
.col-add:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-g)}
.col-body{padding:8px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:7px;min-height:50px;transition:background .15s}
.col-body.over{background:rgba(108,99,255,.04);border-radius:0 0 14px 14px}

/* â”€â”€â”€ Card â”€â”€â”€ */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:9px;padding:11px 13px;cursor:grab;transition:all .15s;user-select:none}
.card:hover{border-color:var(--border-h);transform:translateY(-1px);box-shadow:0 4px 14px rgba(0,0,0,.2)}
.card.dragging{opacity:.4;transform:rotate(2deg) scale(.97)}
.card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;gap:6px}
.pbadge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
.pbadge[data-p="Flycart"]{background:rgba(31,135,255,.15);color:var(--flycart)}
.pbadge[data-p="Yuko"]{background:rgba(108,98,244,.15);color:var(--yuko)}
.pbadge[data-p="Retainful"]{background:rgba(247,90,27,.15);color:var(--retainful)}
.pbadge[data-p="WPLoyalty"]{background:rgba(81,73,235,.15);color:var(--wployalty)}
.pbadge[data-p="UpsellWP"]{background:rgba(4,55,133,.25);color:#4d8ee0}
.pbadge[data-p="Spark Editor"]{background:rgba(22,82,54,.25);color:#3dbb7a}
.pbadge[data-p="Other Works"]{background:rgba(100,116,139,.15);color:var(--other)}
.pdot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.pdot.high{background:#EF4444;box-shadow:0 0 5px #EF4444}
.pdot.medium{background:#F59E0B}
.pdot.low{background:#22C55E}
.card-title{font-size:13px;font-weight:600;line-height:1.35;margin-bottom:3px}
.card-desc{font-size:11px;color:var(--text-dim);line-height:1.4;margin-bottom:7px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.card-tags{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:7px}
.card-tag{font-size:9px;padding:1px 6px;background:var(--bg-hover);border-radius:3px;color:var(--text-dim);font-weight:500}
.card-foot{display:flex;align-items:center;justify-content:space-between;padding-top:7px;border-top:1px solid var(--border)}
.card-who{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text-dim)}
.card-due{font-size:10px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
.card-due.overdue{color:#EF4444}
.card-due.soon{color:#F59E0B}
.card-meta{display:flex;align-items:center;gap:7px}
.card-cmt{font-size:10px;color:var(--text-muted)}
.empty{text-align:center;padding:24px 14px;color:var(--text-muted);font-size:11px}

/* â”€â”€â”€ Modal â”€â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;padding:16px}
.overlay.on{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:16px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;padding:26px}
.modal-hd{font-size:17px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between}
.modal-x{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid var(--border);border-radius:7px;color:var(--text-dim);font-size:15px;transition:all .15s}
.modal-x:hover{border-color:var(--danger);color:var(--danger)}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tags-wrap{display:flex;flex-wrap:wrap;gap:4px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:10px;min-height:40px;align-items:center;cursor:text;transition:border-color .2s,box-shadow .2s}
.tags-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-g)}
.chip{display:flex;align-items:center;gap:3px;padding:2px 7px;background:var(--bg-hover);border-radius:4px;font-size:11px;color:var(--text-dim)}
.chip .rx{cursor:pointer;color:var(--text-muted);font-size:13px;line-height:1}
.chip .rx:hover{color:var(--danger)}
.tags-wrap input{flex:1;min-width:60px;background:none;border:none;color:var(--text);font-size:12px;outline:none}
.mact{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}
.btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid transparent;transition:all .15s}
.btn-p{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn-p:hover{background:#5B54E6}
.btn-s{background:transparent;color:var(--text-dim);border-color:var(--border)}
.btn-s:hover{border-color:var(--border-h);color:var(--text)}
.btn-d{background:transparent;color:var(--danger);border-color:rgba(239,68,68,.3)}
.btn-d:hover{background:rgba(239,68,68,.1)}

/* Comments */
.cmt-sec{margin-top:14px}
.cmt-sec h4{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.cmt{padding:8px 11px;background:var(--bg-input);border-radius:7px;margin-bottom:5px}
.cmt-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px}
.cmt-who{font-size:11px;font-weight:600;color:var(--accent)}
.cmt-dt{font-size:9px;color:var(--text-muted);font-family:'JetBrains Mono',monospace}
.cmt-txt{font-size:12px;color:var(--text-dim);line-height:1.4}
.cmt-add{display:flex;gap:6px;margin-top:8px}
.cmt-add input{flex:1;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;outline:none}
.cmt-add input:focus{border-color:var(--accent)}
.cmt-add button{padding:6px 13px;background:var(--accent);color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:600;white-space:nowrap}

/* Config */
.cfg-sec{margin-bottom:16px}
.cfg-sec h4{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px}
.m-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
.m-row input{flex:1;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:12px;outline:none}
.m-row select{width:100px;padding:6px;background:var(--bg-input);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:11px;outline:none}
.m-row .m-del{width:26px;height:26px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid rgba(239,68,68,.3);border-radius:5px;color:var(--danger);font-size:13px}
.m-add{display:flex;align-items:center;gap:5px;padding:6px 12px;background:transparent;border:1px dashed var(--border);border-radius:7px;color:var(--text-muted);font-size:11px;transition:all .15s;width:100%;justify-content:center;margin-top:4px}
.m-add:hover{border-color:var(--accent);color:var(--accent)}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;padding:10px 18px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;font-size:12px;color:var(--text);z-index:2000;transform:translateY(80px);opacity:0;transition:all .3s;max-width:340px}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:var(--success)}
.toast.error{border-color:var(--danger)}

/* Loading overlay */
.loading-bar{position:fixed;top:0;left:0;width:100%;height:3px;z-index:9999;display:none}
.loading-bar.on{display:block}
.loading-bar::after{content:'';display:block;height:100%;width:30%;background:var(--accent);border-radius:0 2px 2px 0;animation:loadbar 1.2s ease-in-out infinite}
@keyframes loadbar{0%{width:0;margin-left:0}50%{width:60%}100%{width:0;margin-left:100%}}

@media(max-width:768px){
  .header{padding:10px 12px}
  .board{padding:12px;gap:10px}
  .col{min-width:270px;max-width:270px}
  .h-center{display:none}
}
</style>
</head>
<body>

<!-- Loading bar -->
<div class="loading-bar" id="loadbar"></div>

<!-- â•â•â• LOGIN â•â•â• -->
<div id="login">
  <div class="login-box">
    <div class="logo">
      <svg width="34" height="34" viewBox="0 0 36 36" fill="none"><rect width="36" height="36" rx="10" fill="#6C63FF"/><path d="M10 12h6v2h-6zM10 16h10v2H10zM10 20h8v2h-8zM20 12h6v12h-6z" fill="white" opacity=".9"/><path d="M22 14h2v8h-2z" fill="#6C63FF"/></svg>
      <h1>Cartrabbit <span>Tasks</span></h1>
    </div>
    <p class="subtitle">Team task management board</p>

    <div class="fg">
      <label>Team Member</label>
      <select id="l-user"><option value="">Loading membersâ€¦</option></select>
    </div>
    <div class="fg">
      <label>Password</label>
      <input type="password" id="l-pass" placeholder="Enter your password" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="btn-login" id="l-btn" onclick="doLogin()">Sign In</button>
    <div class="msg" id="l-msg"></div>
  </div>
</div>

<!-- â•â•â• APP â•â•â• -->
<div id="app">
  <div class="header">
    <div class="h-left">
      <div class="h-logo">
        <svg width="24" height="24" viewBox="0 0 36 36" fill="none"><rect width="36" height="36" rx="10" fill="#6C63FF"/><path d="M10 12h6v2h-6zM10 16h10v2H10zM10 20h8v2h-8zM20 12h6v12h-6z" fill="white" opacity=".9"/><path d="M22 14h2v8h-2z" fill="#6C63FF"/></svg>
        <span>Tasks</span>
      </div>
      <div class="sbox">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" placeholder="Searchâ€¦" id="search" oninput="renderBoard()">
      </div>
    </div>
    <div class="h-center" id="filters"></div>
    <div class="h-right">
      <span class="sync" id="sync-st">â— Ready</span>
      <button class="ibtn" onclick="refreshData()" title="Refresh"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg></button>
      <button class="ibtn" id="cfg-btn" onclick="openCfg()" title="Settings" style="display:none"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
      <div class="badge"><div class="avatar avatar-sm" id="h-av"></div><span id="h-name"></span></div>
      <button class="ibtn" onclick="doLogout()" title="Logout"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
    </div>
  </div>
  <div class="board" id="board">
    <div class="col" data-s="not-started"><div class="col-head"><div class="col-title"><div class="col-dot"></div>Not Started<span class="col-cnt" data-c="not-started">0</span></div><button class="col-add" onclick="openTask('not-started')">+</button></div><div class="col-body" data-s="not-started"></div></div>
    <div class="col" data-s="pending"><div class="col-head"><div class="col-title"><div class="col-dot"></div>Pending<span class="col-cnt" data-c="pending">0</span></div><button class="col-add" onclick="openTask('pending')">+</button></div><div class="col-body" data-s="pending"></div></div>
    <div class="col" data-s="working"><div class="col-head"><div class="col-title"><div class="col-dot"></div>Working<span class="col-cnt" data-c="working">0</span></div><button class="col-add" onclick="openTask('working')">+</button></div><div class="col-body" data-s="working"></div></div>
    <div class="col" data-s="completed"><div class="col-head"><div class="col-title"><div class="col-dot"></div>Completed<span class="col-cnt" data-c="completed">0</span></div><button class="col-add" onclick="openTask('completed')">+</button></div><div class="col-body" data-s="completed"></div></div>
  </div>
</div>

<!-- â•â•â• TASK MODAL â•â•â• -->
<div class="overlay" id="task-ov">
  <div class="modal">
    <div class="modal-hd"><span id="t-hd">New Task</span><button class="modal-x" onclick="closeTask()">âœ•</button></div>
    <div class="fg"><label>Title</label><input type="text" id="t-title" placeholder="Task titleâ€¦"></div>
    <div class="fg"><label>Description</label><textarea id="t-desc" placeholder="Describe the taskâ€¦"></textarea></div>
    <div class="frow">
      <div class="fg"><label>Product</label><select id="t-prod"><option>Flycart</option><option>Yuko</option><option>Retainful</option><option>WPLoyalty</option><option>UpsellWP</option><option>Spark Editor</option><option>Other Works</option></select></div>
      <div class="fg"><label>Priority</label><select id="t-pri"><option value="high">ğŸ”´ High</option><option value="medium" selected>ğŸŸ¡ Medium</option><option value="low">ğŸŸ¢ Low</option></select></div>
    </div>
    <div class="frow">
      <div class="fg"><label>Assigned To</label><select id="t-assign"></select></div>
      <div class="fg"><label>Due Date</label><input type="date" id="t-due"></div>
    </div>
    <div class="fg"><label>Status</label><select id="t-status"><option value="not-started">Not Started</option><option value="pending">Pending</option><option value="working">Working</option><option value="completed">Completed</option></select></div>
    <div class="fg"><label>Tags (Enter to add)</label><div class="tags-wrap" id="t-tags" onclick="this.querySelector('input')?.focus()"><input type="text" id="t-tags-in" placeholder="Add tagâ€¦"></div></div>
    <div class="cmt-sec" id="cmt-sec" style="display:none"><h4>Comments</h4><div id="cmt-list"></div><div class="cmt-add"><input type="text" id="cmt-in" placeholder="Add a commentâ€¦" onkeydown="if(event.key==='Enter')postComment()"><button onclick="postComment()">Post</button></div></div>
    <div class="mact">
      <button class="btn btn-d" id="t-del" style="display:none;margin-right:auto" onclick="delTask()">Delete</button>
      <button class="btn btn-s" onclick="closeTask()">Cancel</button>
      <button class="btn btn-p" id="t-save" onclick="saveTask()">Create Task</button>
    </div>
  </div>
</div>

<!-- â•â•â• CONFIG MODAL â•â•â• -->
<div class="overlay" id="cfg-ov">
  <div class="modal">
    <div class="modal-hd"><span>âš™ Team Settings</span><button class="modal-x" onclick="closeCfg()">âœ•</button></div>
    <div class="cfg-sec">
      <h4>Team Members</h4>
      <p style="font-size:11px;color:var(--text-muted);margin-bottom:10px">Add members with their passwords. They can login from any device.</p>
      <div id="m-list"></div>
      <button class="m-add" onclick="addMemberRow()">+ Add Member</button>
    </div>
    <div class="mact">
      <button class="btn btn-s" onclick="closeCfg()">Cancel</button>
      <button class="btn btn-p" id="cfg-save" onclick="saveCfg()">Save Members</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸  PASTE YOUR APPS SCRIPT WEB APP URL BELOW  âš ï¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API = 'YOUR_APPS_SCRIPT_WEB_APP_URL_HERE';
// Example: 'https://script.google.com/macros/s/AKfycb.../exec'

const PRODUCTS = ['Flycart','Yuko','Retainful','WPLoyalty','UpsellWP','Spark Editor','Other Works'];
const STATUSES = ['not-started','pending','working','completed'];
const POLL = 30000; // 30s auto-refresh

let S = {
  user: null,
  role: null,
  members: [],
  tasks: [],
  comments: [],
  filterProd: null,
  filterUser: null,
  editId: null,
  editTags: [],
  lastDrag: 0,
  timer: null
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loading(on) { document.getElementById('loadbar').classList.toggle('on', on); }

async function apiGet(params) {
  const url = API + '?' + new URLSearchParams(params).toString();
  const r = await fetch(url);
  return r.json();
}

async function apiPost(data) {
  const r = await fetch(API, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify(data)
  });
  return r.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) { const d = document.createElement('div'); d.textContent = s||''; return d.innerHTML; }
function initials(n) { return (n||'?').split(' ').map(w=>w[0]).join('').toUpperCase().slice(0,2); }
function names() { return S.members.map(m => m.name); }
function isManager() { return S.role === 'manager'; }
function toast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  clearTimeout(t._t); t._t = setTimeout(() => t.className = 'toast', 3500);
}
function syncSt(cls, txt) {
  const e = document.getElementById('sync-st');
  e.className = 'sync ' + cls; e.textContent = 'â— ' + txt;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT â€” Load members for login dropdown
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  // Check if API is configured
  if (API.includes('https://script.google.com/macros/s/AKfycbwEHQFNUmsjiooBR0bR_xxxXSLXppvqBSoKJBv_c1Ycr_4OIecTmVui5__LppOVBDYp/exec')) {
    document.getElementById('l-user').innerHTML = '<option value="">âš ï¸ API URL not configured</option>';
    document.getElementById('l-msg').className = 'msg err';
    document.getElementById('l-msg').textContent = 'Edit index.html and set the API URL at the top of the <script> section.';
    return;
  }

  try {
    const res = await apiGet({ action: 'members' });
    if (res.success) {
      S.members = res.members;
      const sel = document.getElementById('l-user');
      sel.innerHTML = '<option value="">Select your nameâ€¦</option>' +
        res.members.map(m => `<option value="${esc(m.name)}">${esc(m.name)}</option>`).join('');
    } else {
      throw new Error(res.error || 'Failed to load members');
    }
  } catch(e) {
    document.getElementById('l-user').innerHTML = '<option value="">âŒ Connection failed</option>';
    document.getElementById('l-msg').className = 'msg err';
    document.getElementById('l-msg').textContent = 'Cannot reach API: ' + e.message;
  }

  // Auto-login from session
  const saved = sessionStorage.getItem('cb_user');
  const savedRole = sessionStorage.getItem('cb_role');
  if (saved && savedRole) {
    S.user = saved;
    S.role = savedRole;
    showApp();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOGIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const name = document.getElementById('l-user').value;
  const pw = document.getElementById('l-pass').value;
  const msgEl = document.getElementById('l-msg');
  const btn = document.getElementById('l-btn');

  msgEl.className = 'msg'; msgEl.textContent = '';
  if (!name) { msgEl.className = 'msg err'; msgEl.textContent = 'Select your name'; return; }
  if (!pw) { msgEl.className = 'msg err'; msgEl.textContent = 'Enter password'; return; }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Signing inâ€¦';

  try {
    const res = await apiGet({ action: 'login', name, password: pw });
    if (res.success) {
      S.user = res.name;
      S.role = res.role;
      sessionStorage.setItem('cb_user', res.name);
      sessionStorage.setItem('cb_role', res.role);
      showApp();
    } else {
      msgEl.className = 'msg err';
      msgEl.textContent = res.error || 'Login failed';
    }
  } catch(e) {
    msgEl.className = 'msg err';
    msgEl.textContent = 'Connection error: ' + e.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
}

function doLogout() {
  S.user = null; S.role = null;
  sessionStorage.clear();
  clearInterval(S.timer);
  document.getElementById('app').style.display = 'none';
  document.getElementById('login').style.display = 'flex';
  document.getElementById('l-pass').value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function showApp() {
  document.getElementById('login').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('h-name').textContent = S.user;
  document.getElementById('h-av').textContent = initials(S.user);
  document.getElementById('cfg-btn').style.display = isManager() ? '' : 'none';

  await refreshData();

  // Auto-poll
  clearInterval(S.timer);
  S.timer = setInterval(() => refreshData(true), POLL);
}

async function refreshData(silent = false) {
  if (!silent) loading(true);
  syncSt('load', 'Loadingâ€¦');

  try {
    // Fetch members, tasks, and all comments in parallel
    const [mRes, tRes, cRes] = await Promise.all([
      apiGet({ action: 'members' }),
      apiGet({ action: 'tasks' }),
      apiGet({ action: 'allComments' })
    ]);

    if (mRes.success) S.members = mRes.members;
    if (tRes.success) S.tasks = tRes.tasks;
    if (cRes.success) S.comments = cRes.comments;

    renderFilters();
    renderBoard();
    syncSt('ok', new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
  } catch(e) {
    syncSt('err', 'Failed');
    if (!silent) toast('Refresh failed: ' + e.message, 'error');
  } finally {
    loading(false);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFilters() {
  const c = document.getElementById('filters');
  let h = `<button class="fbtn ${!S.filterProd?'on':''}" onclick="fProd(null)">All</button>`;
  PRODUCTS.forEach(p => {
    h += `<button class="fbtn ${S.filterProd===p?'on':''}" data-p="${p}" onclick="fProd('${p}')">${p}</button>`;
  });
  if (names().length > 1) {
    h += `<div class="sep"></div><button class="fbtn ${!S.filterUser?'on':''}" onclick="fUser(null)">ğŸ‘¤ All</button>`;
    names().forEach(m => {
      h += `<button class="fbtn ${S.filterUser===m?'on':''}" onclick="fUser('${esc(m)}')">${esc(m)}</button>`;
    });
  }
  c.innerHTML = h;
}
function fProd(p) { S.filterProd = p; renderFilters(); renderBoard(); }
function fUser(u) { S.filterUser = u; renderFilters(); renderBoard(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderBoard() {
  const q = (document.getElementById('search')?.value||'').toLowerCase();
  STATUSES.forEach(st => {
    const body = document.querySelector(`.col-body[data-s="${st}"]`);
    const cnt = document.querySelector(`[data-c="${st}"]`);
    let tasks = S.tasks.filter(t => t.status === st);
    if (S.filterProd) tasks = tasks.filter(t => t.product === S.filterProd);
    if (S.filterUser) tasks = tasks.filter(t => t.assignee === S.filterUser);
    if (q) tasks = tasks.filter(t =>
      (t.title||'').toLowerCase().includes(q) || (t.description||'').toLowerCase().includes(q) ||
      (t.product||'').toLowerCase().includes(q) || (t.assignee||'').toLowerCase().includes(q) ||
      (t.tags||[]).some(tg => tg.toLowerCase().includes(q))
    );
    const po = {high:0,medium:1,low:2};
    tasks.sort((a,b) => {
      if (po[a.priority]!==po[b.priority]) return po[a.priority]-po[b.priority];
      if (a.due&&b.due) return new Date(a.due)-new Date(b.due);
      return a.due?-1:b.due?1:0;
    });
    cnt.textContent = tasks.length;
    body.innerHTML = tasks.length ? tasks.map(cardHtml).join('') : '<div class="empty">No tasks</div>';
  });
  bindCards();
}

function cardHtml(t) {
  const dc = dueClass(t.due), dt = t.due ? fmtDate(t.due) : '';
  const cc = S.comments.filter(c => c.taskId === t.id).length;
  return `<div class="card" draggable="true" data-id="${t.id}">
    <div class="card-top"><span class="pbadge" data-p="${t.product}">${t.product}</span><span class="pdot ${t.priority}" title="${t.priority}"></span></div>
    <div class="card-title">${esc(t.title)}</div>
    ${t.description?`<div class="card-desc">${esc(t.description)}</div>`:''}
    ${t.tags?.length?`<div class="card-tags">${t.tags.map(tg=>`<span class="card-tag">${esc(tg)}</span>`).join('')}</div>`:''}
    <div class="card-foot">
      <div class="card-who"><div class="avatar avatar-xs">${initials(t.assignee)}</div>${esc(t.assignee||'â€”')}</div>
      <div class="card-meta">${cc?`<span class="card-cmt">ğŸ’¬${cc}</span>`:''}${dt?`<span class="card-due ${dc}">${dt}</span>`:''}</div>
    </div>
  </div>`;
}
function dueClass(d) {
  if (!d) return '';
  const diff = (new Date(d).setHours(0,0,0,0) - new Date().setHours(0,0,0,0)) / 864e5;
  return diff<0?'overdue':diff<=2?'soon':'';
}
function fmtDate(d) {
  const dt = new Date(d);
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()]+' '+dt.getDate();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP + CLICK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dragId = null;

function bindCards() {
  document.querySelectorAll('.card').forEach(c => {
    c.addEventListener('dragstart', function(e) {
      dragId = this.dataset.id;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', dragId);
      S.lastDrag = Date.now();
    });
    c.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      document.querySelectorAll('.col-body').forEach(b => b.classList.remove('over'));
    });
    c.addEventListener('click', function() {
      if (Date.now() - S.lastDrag < 300) return;
      openEdit(this.dataset.id);
    });
  });
  document.querySelectorAll('.col-body').forEach(b => {
    b.ondragover = function(e) { e.preventDefault(); this.classList.add('over'); };
    b.ondragleave = function() { this.classList.remove('over'); };
    b.ondrop = async function(e) {
      e.preventDefault(); this.classList.remove('over');
      const ns = this.dataset.s;
      if (!dragId || !ns) return;
      const task = S.tasks.find(t => t.id === dragId);
      if (task && task.status !== ns) {
        task.status = ns;
        task.updatedBy = S.user;
        renderBoard();
        await apiPost({ action: 'saveTask', task });
        syncSt('ok', 'Saved');
      }
      dragId = null;
    };
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TASK MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTask(status) {
  S.editId = null; S.editTags = [];
  document.getElementById('t-hd').textContent = 'New Task';
  document.getElementById('t-title').value = '';
  document.getElementById('t-desc').value = '';
  document.getElementById('t-prod').value = 'Flycart';
  document.getElementById('t-pri').value = 'medium';
  document.getElementById('t-status').value = status || 'not-started';
  document.getElementById('t-due').value = '';
  document.getElementById('t-del').style.display = 'none';
  document.getElementById('t-save').textContent = 'Create Task';
  document.getElementById('cmt-sec').style.display = 'none';
  fillAssignees();
  renderTags();
  document.getElementById('task-ov').classList.add('on');
  document.getElementById('t-title').focus();
}

function openEdit(id) {
  const t = S.tasks.find(x => x.id === id);
  if (!t) return;
  S.editId = id;
  S.editTags = [...(t.tags||[])];
  document.getElementById('t-hd').textContent = 'Edit Task';
  document.getElementById('t-title').value = t.title||'';
  document.getElementById('t-desc').value = t.description||'';
  document.getElementById('t-prod').value = t.product||'Flycart';
  document.getElementById('t-pri').value = t.priority||'medium';
  document.getElementById('t-status').value = t.status||'not-started';
  document.getElementById('t-due').value = t.due||'';
  const canDel = isManager() || t.createdBy === S.user;
  document.getElementById('t-del').style.display = canDel ? 'block' : 'none';
  document.getElementById('t-save').textContent = 'Update Task';
  fillAssignees();
  document.getElementById('t-assign').value = t.assignee||'';
  renderTags();
  // Comments
  const cmts = S.comments.filter(c => c.taskId === id);
  document.getElementById('cmt-sec').style.display = 'block';
  document.getElementById('cmt-list').innerHTML = cmts.map(c => `
    <div class="cmt"><div class="cmt-hd"><span class="cmt-who">${esc(c.author)}</span><span class="cmt-dt">${new Date(c.date).toLocaleDateString()}</span></div><div class="cmt-txt">${esc(c.text)}</div></div>
  `).join('') || '<div class="empty">No comments yet</div>';
  document.getElementById('cmt-in').value = '';
  document.getElementById('task-ov').classList.add('on');
}

function closeTask() { document.getElementById('task-ov').classList.remove('on'); S.editId = null; }

function fillAssignees() {
  document.getElementById('t-assign').innerHTML = names().map(m => `<option value="${esc(m)}">${esc(m)}</option>`).join('');
}

// Tags
function renderTags() {
  const w = document.getElementById('t-tags');
  w.innerHTML = S.editTags.map((t,i) =>
    `<span class="chip">${esc(t)}<span class="rx" onclick="event.stopPropagation();rmTag(${i})">Ã—</span></span>`
  ).join('') + '<input type="text" id="t-tags-in" placeholder="Add tagâ€¦" onkeydown="tagKey(event)">';
}
function tagKey(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const v = e.target.value.trim();
    if (v && !S.editTags.includes(v)) { S.editTags.push(v); renderTags(); }
  }
}
function rmTag(i) { S.editTags.splice(i, 1); renderTags(); }

// Comment
async function postComment() {
  if (!S.editId) return;
  const text = document.getElementById('cmt-in').value.trim();
  if (!text) return;
  document.getElementById('cmt-in').value = '';

  try {
    const res = await apiPost({ action: 'addComment', taskId: S.editId, author: S.user, text });
    if (res.success && res.comment) {
      S.comments.push(res.comment);
      // Re-render comments in modal
      const cmts = S.comments.filter(c => c.taskId === S.editId);
      document.getElementById('cmt-list').innerHTML = cmts.map(c => `
        <div class="cmt"><div class="cmt-hd"><span class="cmt-who">${esc(c.author)}</span><span class="cmt-dt">${new Date(c.date).toLocaleDateString()}</span></div><div class="cmt-txt">${esc(c.text)}</div></div>
      `).join('');
      renderBoard(); // Update comment count on cards
      toast('Comment added', 'success');
    }
  } catch(e) {
    toast('Failed to add comment', 'error');
  }
}

// Save
async function saveTask() {
  const title = document.getElementById('t-title').value.trim();
  if (!title) { toast('Enter a title', 'error'); return; }

  const btn = document.getElementById('t-save');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Savingâ€¦';

  const task = {
    title,
    description: document.getElementById('t-desc').value.trim(),
    product: document.getElementById('t-prod').value,
    priority: document.getElementById('t-pri').value,
    assignee: document.getElementById('t-assign').value,
    status: document.getElementById('t-status').value,
    due: document.getElementById('t-due').value || '',
    tags: [...S.editTags],
    updatedBy: S.user
  };

  if (S.editId) {
    task.id = S.editId;
  } else {
    task.createdBy = S.user;
  }

  try {
    const res = await apiPost({ action: 'saveTask', task });
    if (res.success) {
      if (S.editId) {
        const idx = S.tasks.findIndex(t => t.id === S.editId);
        if (idx !== -1) S.tasks[idx] = { ...S.tasks[idx], ...task, ...res.task };
      } else if (res.task) {
        S.tasks.push(res.task);
      }
      closeTask();
      renderBoard();
      toast(S.editId ? 'Task updated!' : 'Task created!', 'success');
    } else {
      toast(res.error || 'Save failed', 'error');
    }
  } catch(e) {
    toast('Save failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = S.editId ? 'Update Task' : 'Create Task';
  }
}

async function delTask() {
  if (!S.editId || !confirm('Delete this task permanently?')) return;
  try {
    const res = await apiPost({ action: 'deleteTask', id: S.editId });
    if (res.success) {
      S.tasks = S.tasks.filter(t => t.id !== S.editId);
      S.comments = S.comments.filter(c => c.taskId !== S.editId);
      closeTask();
      renderBoard();
      toast('Task deleted', 'success');
    } else {
      toast(res.error || 'Delete failed', 'error');
    }
  } catch(e) {
    toast('Delete failed: ' + e.message, 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS (Manager only)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cfgMembers = [];

function openCfg() {
  if (!isManager()) { toast('Managers only', 'error'); return; }
  cfgMembers = S.members.map(m => ({ ...m, password: '', isNew: false }));
  renderMembers();
  document.getElementById('cfg-ov').classList.add('on');
}
function closeCfg() { document.getElementById('cfg-ov').classList.remove('on'); }

function renderMembers() {
  document.getElementById('m-list').innerHTML = cfgMembers.map((m, i) => `
    <div class="m-row">
      <input type="text" value="${esc(m.name)}" placeholder="Name" data-mi="${i}" ${m.isNew?'':'readonly'} style="${m.isNew?'':'opacity:.7'}">
      <input type="text" value="${esc(m.password||'')}" placeholder="${m.isNew?'Password':'New password (optional)'}" data-mp="${i}">
      <select data-mr="${i}"><option value="manager" ${m.role==='manager'?'selected':''}>Manager</option><option value="member" ${m.role!=='manager'?'selected':''}>Member</option></select>
      <button class="m-del" onclick="rmMember(${i})" ${m.name===S.user?'disabled style="opacity:.3"':''}>Ã—</button>
    </div>
  `).join('');
}

function addMemberRow() {
  cfgMembers.push({ name: '', password: '', role: 'member', isNew: true });
  renderMembers();
  setTimeout(() => {
    const inputs = document.querySelectorAll('[data-mi]');
    inputs[inputs.length-1]?.focus();
  }, 50);
}

function rmMember(i) {
  if (cfgMembers[i].name === S.user) return;
  cfgMembers.splice(i, 1);
  renderMembers();
}

async function saveCfg() {
  const btn = document.getElementById('cfg-save');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Savingâ€¦';

  try {
    for (let i = 0; i < cfgMembers.length; i++) {
      const nameEl = document.querySelector(`[data-mi="${i}"]`);
      const passEl = document.querySelector(`[data-mp="${i}"]`);
      const roleEl = document.querySelector(`[data-mr="${i}"]`);
      const name = nameEl ? nameEl.value.trim() : cfgMembers[i].name;
      const password = passEl ? passEl.value.trim() : '';
      const role = roleEl ? roleEl.value : cfgMembers[i].role;

      if (!name) continue;

      if (cfgMembers[i].isNew) {
        // Add new member
        if (!password) { toast(`Password required for ${name}`, 'error'); btn.disabled=false; btn.textContent='Save Members'; return; }
        const res = await apiPost({ action: 'addMember', member: { name, password, role } });
        if (!res.success) { toast(res.error || `Failed to add ${name}`, 'error'); }
      } else {
        // Update existing member (password and/or role)
        const update = { name, role };
        if (password) update.password = password;
        await apiPost({ action: 'updateMember', member: update });
      }
    }

    // Handle removals
    const currentNames = [];
    for (let i = 0; i < cfgMembers.length; i++) {
      const nameEl = document.querySelector(`[data-mi="${i}"]`);
      currentNames.push(nameEl ? nameEl.value.trim() : cfgMembers[i].name);
    }
    for (const m of S.members) {
      if (!currentNames.includes(m.name)) {
        await apiPost({ action: 'removeMember', name: m.name });
      }
    }

    closeCfg();
    toast('Members updated!', 'success');
    await refreshData();
  } catch(e) {
    toast('Save failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Members';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeTask(); closeCfg(); }
  if ((e.ctrlKey||e.metaKey) && e.key === 'n') { e.preventDefault(); openTask('not-started'); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
</script>
</body>
</html>
